<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="main.css">
    <link href='http://fonts.googleapis.com/css?family=Scada:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

    <!-- <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css"> -->
    <link rel="stylesheet" href="jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <title>Частота ошибок в ответах на экзамене по ПДД</title>
    <link rel="shortcut icon" href="favicon.ico">
    <!-- Yandex.Metrika counter --> <script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter35945155 = new Ya.Metrika({ id:35945155, clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div><img src="https://mc.yandex.ru/watch/35945155" style="position:absolute; left:-9999px;" alt="" /></div></noscript> <!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="everything">
        <div class="header">
            <div><h1><div class="headertext"><b>Частота ошибок в ответах на экзамене по <span class="capitel">ПДД  </span></b></div></h1></div>
        </div>
        <div class="clear"></div>
        <div class="sliderContainer">

            <div id="slider"></div>
            <div class="captions">
                <div class="try1"><span style="margin-left: 38px;">1 попытка</span></div>
                <div class="try2"><span style="margin-left: -10px;">5</span></div>
                <div class="try3"><span style="margin-left: -5px;">10</span></div>
                <div class="try4">15</div>
            </div>
            <div class="ticks">
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
                <div class="tick"><div style="width:1px; height:10px; background-color:#cccccc;"> </div></div>
            </div>
        </div>
        <div class="diagramContainer">
            <div class="diagram"></div>
            <div class="them"></div>
            <div class="question">
                <div class="questionWrap">
                    <div class="qHeader">
                        <div class="qCard"><b>Билет 14</b></div>
                    </div>
                    <div class="clear"></div>
                    <div class="pic"><img src=""></div>
                    <div class="qText"> Какие транспортные средства по Правилам относятся к маршрутным транспортным средствам?</div>
                    <div class="qAnsw">
                    <div class="qAnsw1"> &bull; Автобусы, троллейбусы и трамваи, предназначенные для перевозки людей и движущиеся по установленному маршруту с обозначенными местами остановок.</div>
                    <div class="qAnsw2"> &bull; Любые транспортные средства, перевозящие пассажиров.</div>
                    <div class="qAnsw3"> &bull; Все автобусы.</div>
                    <div class="qAnsw4"> </div>
                    <div class="qAnsw5"> </div>
                        </div>
                </div>
                <div class="percent">
                    <div class="percentText"></div>
                </div>
            </div>
            <div class="legend1"></div>
            <div class="legend2"></div>
        </div>

    </div>
    <div class="clear"></div>
    <div class="caption">
        Визуализация <a href="http://datalaboratory.ru">Лаборатории данных</a>. Статистика сервиса <a href="http://pdd.atrena.org/">pdd.atrena.org</a> с 18 марта 2012 по 1 января 2015 года.
    </div>


<script src="scripts/d3.v3.min.js" charset="utf-8"></script>
<script>

        currentTry = 0;
        var svg, tem;

        var color = d3.scale.linear()
                .domain([60,80,100])
                .range(['#e76f4e', '#fef5b8', '#6abf60']);

        function getAverageError(max,array,sliderPosition) {
            sum = 0;
            for(i=0; i<20; i++)
            {
                for(j=1; j<41; j++)
                {
                    if ( Number(array[i][""+j])>max) {sum += max} else {sum += Number(array[i][""+j])}
                }
            }
            ratio = 100/max;
            sum = sum*ratio;
            return Math.round(sum/20/40 - (sliderPosition-1)*4);
        };



        /*function updateColor(minRightAnswers){
            return color
                .domain([minRightAnswers, (100-minRightAnswers)/2, 100])
                .range(['#6abf60', '#fef5b8', '#e76f4e']);

            //questions
            //  .data(function (d) { return d.values})
            //  .selectAll('rect')

        };*/

        var size = 15;
        var sliderPosition = 1;
        var margin = {top: 0, right: 0, bottom: 0, left: 60};
        var width = size*8*5+126;
        var height = size*5*4+130;
        var nested, nestev, sky, questions, themes;

        drawDiagram(1);

        function findMaxError(questionList){
            sum = 0;
            count = 0;
            min = 100;
            //console.log(questionList[1].values)

            for(i=0; i<questionList.length; i++)
            {
                biletList = questionList[i].values;
                for (j=0; j<biletList.length; j++)
                {
                    correctRatio = (biletList[j].correct/biletList[j].user_count)*100
                    if(correctRatio<min) {min = correctRatio;};
                    sum += correctRatio;
                    count++;
                }
            }

            return [min,sum,count];
        };

        function updateDiagram(){

                //console.log(nested[14].values[39].values[19]);

                //console.log("try: ", currentTry, " nested: ", nested, " values: ", nested[currentTry].values);
                //console.log("before: ", nested[currentTry].values);
                minRightAnsw = findMaxError(nested[currentTry].values);

                //загружаем данные по вопросам
                currentTryData = nested[currentTry].values;


                //расставляем вопросы по порядку
                currentTryData = currentTryData.sort(function (a, b) {// console.log("a:",a," b:", b);
                    if (Number(a.key) < Number(b.key)) {
                        return -1;
                    }
                    if (Number(a.key) > Number(b.key)) {
                        return 1;
                    }
                    return 0;
                });
                //console.log(currentTryData);
                /*
             //console.log("Added data1: ",currentTryData);
             stop = currentTryData.length;
             var offset = 0;
             for(i=1; i<stop; i++){

             delta = Number(currentTryData[i].key) - Number(currentTryData[i-1].key)-1;

             //console.log("iteration: ", i, " delta:", delta," offset:",offset);
             for(j=0; j<delta; j++)
             {
             //console.log("added: ", i+offset+j+1, " i:", i, " j:",j)
             currentTryData.push({"key": i+offset+j+1+"", "values": []});
             }
             offset+= delta;
             }
             if(currentTryData.length <20){
             for(i=currentTryData.length; i<20; i++){
             currentTryData.push({"key": i+1+"", "values": []});
             }
             }
             currentTryData = currentTryData.sort(function (a, b){ //console.log("a:",a," b:", b);
             if (Number(a.key) < Number(b.key)) {return -1;}
             if (Number(a.key) > Number(b.key)) {return 1;}
             return 0;
             });
             //console.log("Added data2: ",currentTryData);

             //console.log("try: ", currentTry, " Current try data2: ", currentTryData);

             */
                themeData = [];
                m = currentTry;


                    tick = [];
                    tick[1] = []; for (i = 0; i < 40; i++) {tick[1].push(nested[m].values[i].values[0])};
                    tick[2] = []; for (i = 0; i < 40; i++) {tick[2].push(nested[m].values[i].values[1])};
                    for (i = 0; i < 40; i++) {tick[2].push(nested[m].values[i].values[2])};
                    for (i = 0; i < 40; i++) {tick[2].push(nested[m].values[i].values[3])};
                    tick[3] = [];for (i = 0; i < 40; i++) {tick[3].push(nested[m].values[i].values[4])};
                    tick[4] = [];for (i = 0; i < 40; i++) {tick[4].push(nested[m].values[i].values[5])};
                    tick[5] = [];for (i = 0; i < 40; i++) {tick[5].push(nested[m].values[i].values[6])};
                    for (i = 0; i < 40; i++) {tick[5].push(nested[m].values[i].values[7])};
                    for (i = 0; i < 40; i++) {tick[5].push(nested[m].values[i].values[8])};
                    tick[6] = [];for (i = 0; i < 40; i++) {tick[6].push(nested[m].values[i].values[9])};
                    tick[7] = [];for (i = 0; i < 40; i++) {tick[7].push(nested[m].values[i].values[10])};
                    tick[8] = [];for (i = 0; i < 40; i++) {tick[8].push(nested[m].values[i].values[11])};
                    tick[9] = [];for (i = 0; i < 40; i++) {tick[9].push(nested[m].values[i].values[12])};
                    for (i = 0; i < 40; i++) {tick[9].push(nested[m].values[i].values[13])};
                    for (i = 0; i < 40; i++) {tick[9].push(nested[m].values[i].values[14])};
                    tick[10] = [];for (i = 0; i < 40; i++) {tick[10].push(nested[m].values[i].values[15])};
                    tick[11] = [];for (i = 0; i < 40; i++) {tick[11].push(nested[m].values[i].values[16])};
                    tick[12] = [];for (i = 0; i < 40; i++) {tick[12].push(nested[m].values[i].values[17])};
                    for (i = 0; i < 40; i++) {tick[12].push(nested[m].values[i].values[18])};
                    for (i = 0; i < 40; i++) {tick[12].push(nested[m].values[i].values[19])};

                    tickTw = []; for (l = 1; l < 13; l++) {tickTw.push({key: l, values: tick[l]})};





            //console.log(tickTw[8].values);
            //console.log(currentTryData[8].values);

            var rmv = svg
                    .selectAll('text')
                    .remove();
            var b = svg
                    .selectAll('rect')
                    .attr('fill', '#ebebeb');
            var c = svg
                    .selectAll('.tkt')
                    .append('text')
                    .text(function (d) {
                        //console.log(d);
                        if(Number($(this).parent().attr("id"))==0){
                            return "Билет 1";
                        }
                        else
                        {
                            return ""+ (Number($(this
                                    ).parent().attr("id"))+1);
                        }
                    })
                    .attr('y', 72)
                    .attr('font-weight',"bold");

            var trmv = tem
                    .selectAll('text')
                    .remove();
            var tb = tem
                    .selectAll('rect')
                    .attr('fill', '#ebebeb');
            var tc = tem
                    .selectAll('.tkt')
                    .append('text')
                    .text(function (d) {//console.log(nestev[$(this).parent().attr("id")].key);
                            return " " + (nestev[$(this).parent().attr("id")].key);
                    })
                    .attr('y', -6)
                    .style("font-size","12px");




            function average(dater) {

                sumUsers = 0;
                sumCorrect = 0;
                for(j=0; j<dater.values.length; j++) {
                    sumUsers +=
                            Number(dater.values[j].user_count);
                    sumCorrect += Number(dater.values[j].correct);
                }
                ave = Math.round((( sumUsers- sumCorrect)/( sumUsers/dater.values.length) ) *10) /10;
                return ave;

            }
            var dat = svg
                    .attr('class', 'dat')
                    .append('rect')
                    .attr('display','none')
                    .attr('width', 282)
                    .attr('height',21)
                    .attr('fill', 'white')
                    .attr('fill-opacity',0.8)
                    .attr('x', -2)
                    .attr('stroke', 'rgba(0,0,0,0.2)')
                    .attr('stroke-width', 1);
            datt =svg.append('text')
                    .text('');


                var d = svg
                        .selectAll('.tkt')
                        .insert("svg:image")
                        .attr('x', 60)
                        .attr('y', 64)
                        .attr('width', 15)
                        .attr('height', 10)
                        .attr("xlink:href", function (d, i) {
                            average(currentTryData[i]);
                            if (ave <= 1) {
                                return "dcheck.png";
                            }
                            else if (ave < 2.1) {
                                return "check.png";
                            }
                            else {
                                return "cross.png";
                            }
                        })

                        .on('mouseover', function (d, i) {
                            average(currentTryData[i]);

                            dat.attr('display', 'block');


                            if (i < 4) {
                                dat
                                        .attr('x', 6.2 * size * i + 75)
                                        .attr('y', 3 * size)

                            }
                            else if (i < 8) {
                                dat.attr('x', 6.2 * size * i - 205)
                                dat.attr('y', 3 * size)
                            }
                            else if (i < 12) {
                                dat.attr('x', 6.2 * size * (i - 8) + 75)
                                dat.attr('y', 8.5 * size)
                            }
                            else if (i < 16) {
                                dat.attr('x', 6.2 * size * (i - 8) - 205)
                                dat.attr('y', 8.5 * size)
                            }
                            else if (i < 20) {
                                dat.attr('x', 6.2 * size * (i - 16) + 75)
                                dat.attr('y', 14 * size)
                            }
                            else if (i < 24) {
                                dat.attr('x', 6.2 * size * (i - 16) - 205)
                                dat.attr('y', 14 * size)
                            }
                            else if (i < 28) {
                                dat.attr('x', 6.2 * size * (i - 24) + 75)
                                dat.attr('y', 19.5 * size)
                            }
                            else if (i < 32) {
                                dat.attr('x', 6.2 * size * (i - 24) - 205)
                                dat.attr('y', 19.5 * size)
                            }
                            else if (i < 36) {
                                dat.attr('x', 6.2 * size * (i - 32) + 75)
                                dat.attr('y', 25 * size)
                            }
                            else {
                                dat.attr('x', 6.2 * size * (i - 32) - 205)
                                dat.attr('y', 25 * size)
                            }

                            datt.attr('display', 'block');
                            if (ave < 1) {
                                datt.text("В среднем " + (ave) + " ошибки на человека - экзамен точно сдан!");
                                dat.attr('width', 303);
                            }
                            else if (ave == 1) {
                                datt.text("В среднем " + (ave) + " ошибка на человека - экзамен точно сдан!");
                                dat.attr('width', 294);
                            }
                            else if (ave < 2) {
                                datt.text("В среднем " + (ave) + " ошибки на человека - экзамен сдан!");
                                dat.attr('width', 270);
                            }

                            else {
                                datt.text("В среднем " + (ave) + " ошибки человека - экзамен не сдан!");
                                dat.attr('width', 270);
                            }


                            if (i < 4) {
                                datt
                                        .attr('x', 6.2 * size * i + 77)
                                        .attr('y', 4 * size)


                            }
                            else if (i < 8) {
                                datt.attr('x', 6.2 * size * i - 203)
                                datt.attr('y', 4 * size)
                            }
                            else if (i < 12) {
                                datt.attr('x', 6.2 * size * (i - 8) + 77)
                                datt.attr('y', 9.5 * size)
                            }
                            else if (i < 16) {
                                datt.attr('x', 6.2 * size * (i - 8) - 203)
                                datt.attr('y', 9.5 * size)
                            }
                            else if (i < 20) {
                                datt.attr('x', 6.2 * size * (i - 16) + 77)
                                datt.attr('y', 15 * size)
                            }
                            else if (i < 24) {
                                datt.attr('x', 6.2 * size * (i - 16) - 203)
                                datt.attr('y', 15 * size)
                            }
                            else if (i < 28) {
                                datt.attr('x', 6.2 * size * (i - 24) + 77)
                                datt.attr('y', 20.5 * size)
                            }
                            else if (i < 32) {
                                datt.attr('x', 6.2 * size * (i - 24) - 203)
                                datt.attr('y', 20.5 * size)
                            }
                            else if (i < 36) {
                                datt.attr('x', 6.2 * size * (i - 32) + 77)
                                datt.attr('y', 26 * size)
                            }
                            else {
                                datt.attr('x', 6.2 * size * (i - 32) - 203)
                                datt.attr('y', 26 * size)
                            }

                        })
                        .on('mouseout', function (d, i) {
                            dat.attr('display', 'none');
                            datt.attr('display', 'none');


                        })


                var a = svg
                        .selectAll('g')

                        .selectAll('rect')

                        .data(function (d, i) {//console.log(currentTryData);
                            return currentTryData[i].values
                        })
                        .attr('user_count', function (d) {
                            return d.user_count;
                        })
                        .attr('correct', function (d) {
                            return d.correct;
                        })
                        .attr('fill', function (d) {

                            return color((d.correct / d.user_count) * 100)
                        })
                        .on('mouseover', function (d, i) {
                            $(".question").show();
                            $(".percent").show();
                            $(".legend1").hide();
                            $(".legend2").hide();


                            d3.select(this).attr('stroke-width', '1').attr('stroke', 'rgb(0,0,0)')

                            //console.log(d3.select(this));
                            $(".questionWrap").css("border", "1px solid #e2e2e2");
                            $(".questionWrap").show();

                            answ = Number($(this).attr("user_count"));
                            corr = Number($(this).attr("correct"))
                            percentErrors = Math.round((1 - corr / answ) * 100);

                            $(".percentText").html("<b>" + (currentTry + 1) + "-я попытка: </b>" + answ + " ответов, <span style='background-color: " + color(100 * d.correct / d.user_count) + ";'>&nbsp;" + percentErrors + "% ошибок&nbsp;</span>");
                            /*questionId = Number($(this).attr("id"));
                             cardId = Number($(this).parent().attr("id"))+1;

                             curQuestion = questionsData[(cardId*20+questionId)%100];

                             $(".qCard").html("<b>Билет "+cardId+", вопрос "+questionId+"</b>");
                             $(".qQuestion").html("Вопрос "+questionId+"");
                             if(curQuestion.type == "pic"){
                             $(".pic").css("display","block");
                             $(".pic").html("<img src='"+curQuestion.pic+"'>");
                             }
                             else
                             {
                             $(".pic").css("display","none");
                             }
                             //$(".qText").html(curQuestion.text);
                             */

                            $(".qCard").html("<b>Билет " + d.bilet + ", вопрос " + (i + 1) + "</b>");
                            $(".qText").html(sky[20 * (d.bilet - 1) + i].question);
                            if (sky[20 * (d.bilet - 1) + i].img == "")  $(".pic").hide();
                            else {
                                $(".pic").show();
                                $(".pic").html("<img src='" + sky[20 * (d.bilet - 1) + i].img + "'>");
                            }
                            if (sky[20 * (d.bilet - 1) + i].answers[0].is_right == 1) $(".qAnsw1").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[0].text + '</i></span>');
                            else $(".qAnsw1").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[0].text);
                            if (sky[20 * (d.bilet - 1) + i].answers[1].is_right == 1) $(".qAnsw2").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[1].text + '</i></span>');
                            else $(".qAnsw2").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[1].text);

                            if (sky[20 * (d.bilet - 1) + i].answers.length > 2) {
                                if (sky[20 * (d.bilet - 1) + i].answers[2].is_right == 1) $(".qAnsw3").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[2].text + '</i></span>');
                                else $(".qAnsw3").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[2].text);
                                if (sky[20 * (d.bilet - 1) + i].answers.length > 3) {
                                    if (sky[20 * (d.bilet - 1) + i].answers[3].is_right == 1) $(".qAnsw4").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[3].text + '</i></span>');
                                    else $(".qAnsw4").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[3].text);
                                    if (sky[20 * (d.bilet - 1) + i].answers.length > 4) {
                                        if (sky[20 * (d.bilet - 1) + i].answers[4].is_right == 1) $(".qAnsw5").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[4].text + '</i></span>');
                                        else $(".qAnsw5").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + i].answers[4].text);
                                    }
                                    else
                                        $(".qAnsw5").html("");
                                }
                                else {
                                    $(".qAnsw4").html("");
                                    $(".qAnsw5").html("");
                                }
                            }
                            else {
                                $(".qAnsw3").html("");
                                $(".qAnsw4").html("");
                                $(".qAnsw5").html("");
                            }


                            //console.log(sky[20*(d.bilet-1)+i].answers[0].is_right);
                            //console.log(sky)


                        })
                        .on('mouseout', function (d, i) {
                            $(".legend1").show();
                            $(".legend2").show();
                            d3.select(this).attr('stroke-width', '0').attr('stroke', 'rgb(0,0,0)');
                            $(".question").hide();
                            $(".questionWrap").hide();
                            $(".percent").hide();
                        })
                //console.log(minRightAnsw[0],(100-minRightAnsw[0])/2+minRightAnsw[0] ,100);
                //console.log("selected_length: ",a.length," selected: ",a);


                var ta = tem
                        .selectAll('g')

                        .selectAll('rect')

                        .data(function (d, i) {//console.log(i);
                            return tickTw[i].values
                        })
                        .attr('user_count', function (d) {
                            return d.user_count;
                        })
                        .attr('correct', function (d) {
                            return d.correct;
                        })
                        .attr('fill', function (d) {

                            return color((d.correct / d.user_count) * 100)
                        })
                        .on('mouseover', function (d, i) {
                            $(".question").show();
                            $(".percent").show();
                            $(".legend1").hide();
                            $(".legend2").hide();


                            d3.select(this).attr('stroke-width', '1').attr('stroke', 'rgb(0,0,0)')

                            //console.log(d3.select(this));
                            $(".questionWrap").css("border", "1px solid #e2e2e2");
                            $(".questionWrap").show();

                            answ = Number($(this).attr("user_count"));
                            corr = Number($(this).attr("correct"))
                            percentErrors = Math.round((1 - corr / answ) * 100);

                            $(".percentText").html("<b>" + (currentTry + 1) + "-я попытка: </b>" + answ + " ответов, <span style='background-color: " + color(100 * d.correct / d.user_count) + ";'>" + percentErrors + "% ошибок </span>");
                            /*questionId = Number($(this).attr("id"));
                             cardId = Number($(this).parent().attr("id"))+1;

                             curQuestion = questionsData[(cardId*20+questionId)%100];

                             $(".qCard").html("<b>Билет "+cardId+", вопрос "+questionId+"</b>");
                             $(".qQuestion").html("Вопрос "+questionId+"");
                             if(curQuestion.type == "pic"){
                             $(".pic").css("display","block");
                             $(".pic").html("<img src='"+curQuestion.pic+"'>");
                             }
                             else
                             {
                             $(".pic").css("display","none");
                             }
                             //$(".qText").html(curQuestion.text);
                             */


                            $(".qCard").html("<b>Билет " + d.bilet + ", вопрос " + d.vopros + "</b>");
                            $(".qText").html(sky[20 * (d.bilet - 1) + (d.vopros - 1)].question);
                            if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].img == "")  $(".pic").hide();
                            else {
                                $(".pic").show();
                                $(".pic").html("<img src='" + sky[20 * (d.bilet - 1) + (d.vopros - 1)].img + "'>");
                            }
                            if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[0].is_right == 1) $(".qAnsw1").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[0].text + '</span>');
                            else $(".qAnsw1").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[0].text);
                            if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[1].is_right == 1) $(".qAnsw2").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[1].text + '</span>');
                            else $(".qAnsw2").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[1].text);

                            if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers.length > 2) {
                                if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[2].is_right == 1) $(".qAnsw3").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[2].text + '</span>');
                                else $(".qAnsw3").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[2].text);
                                if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers.length > 3) {
                                    if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[3].is_right == 1) $(".qAnsw4").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[3].text + '</span>');
                                    else $(".qAnsw4").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[3].text);
                                    if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers.length > 4) {
                                        if (sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[4].is_right == 1) $(".qAnsw5").html("<span ><i><span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[4].text + '</span>');
                                        else $(".qAnsw5").html("<span class='bullit'>&bull;</span> " + sky[20 * (d.bilet - 1) + (d.vopros - 1)].answers[4].text);
                                    }
                                    else
                                        $(".qAnsw5").html("");
                                }
                                else {
                                    $(".qAnsw4").html("");
                                    $(".qAnsw5").html("");
                                }
                            }
                            else {
                                $(".qAnsw3").html("");
                                $(".qAnsw4").html("");
                                $(".qAnsw5").html("");
                            }


                            //console.log(sky[20*(d.bilet-1)+i].answers[0].is_right);
                            //console.log(sky)


                        })
                        .on('mouseout', function (d, i) {
                            $(".legend1").show();
                            $(".legend2").show();
                            d3.select(this).attr('stroke-width', '0').attr('stroke', 'rgb(0,0,0)');
                            $(".question").hide();
                            $(".questionWrap").hide();
                            $(".percent").hide();
                        })
        }

        function drawDiagram(sliderPosition) {
            d3.json('pdd.json', function (skys) {
                sky = skys;

                nestev = d3.nest()
                        .key(function (d) {
                            return d.theme
                        })
                        .entries(skys);

                d3.tsv('pdd.csv', function (rows) {

                    nested = d3.nest()
                            .key(function (d) {
                                return d.order_number
                            })
                            .key(function (d) {
                                return d.bilet
                            })
                            .entries(rows);


                    //создаем слайдер нужной длины
                    $(function () {
                        $("#slider").slider({
                            value: 0,
                            min: 0,
                            max: 14,
                            step: 1,
                            slide: function (event, ui) {
                                currentTry = ui.value;
                                if (currentTry >= nested.length) {
                                    currentTry = nested.length - 1
                                }
                                ;
                                //console.log("current try: ", currentTry);
                                //console.log(currentTry, ui.value);
                                updateDiagram();
                            }
                        });
                    });

                    //создаем кнопки
                    $('<button id="button1">по вопросам</button>', {id: 'button1'}).appendTo('h1');
                    $('<button id="button2">по темам</button>').appendTo('h1');
                    $('#button1').addClass('on');
                    $('#button2').addClass('off');
                    $('.them').hide();

                    $('#button1').mouseover(function () {
                        if ($('#button1').hasClass('off'))
                            $('#button1').removeClass('off').addClass('cl');
                    })

                    $('#button1').mouseout(function () {
                        if ($('#button1').hasClass('cl'))
                            $('#button1').removeClass('cl').addClass('off');

                    })

                    $('#button2').mouseover(function () {
                        if ($('#button2').hasClass('off'))
                            $('#button2').removeClass('off').addClass('cl');
                    })

                    $('#button2').mouseout(function () {
                        if ($('#button2').hasClass('cl'))
                            $('#button2').removeClass('cl').addClass('off');
                    })

                    $('#button1').click(function () {
                        if ($('#button1').hasClass('cl'))
                            $('#button1').removeClass('cl').addClass('on'),
                                    $('.them').hide(),
                                    $('#slider').css('width', '726px'),
                                    $('.tick').css('width', '51.8px'),
                                    $('.try1').css('margin-left', '126px'),
                                    $('.try2').css('margin-left', '0px'),
                                    $('.try3').css('margin-left', '0px'),
                                    $('.try4').css('margin-left', '0px'),
                                    $('.captions').css('margin', '8px 0 0 -164px'),
                                    $('.legend1').css('margin', '270px 250px 0 770px'),
                                    $('.legend2').css('margin', '14px 295px 0 770px'),
                                    $('.diagram').fadeIn(),
                                    $('svg').attr('height', height),
                                    $('.diagramContainer').css('height', height),
                                    $('#button2').removeClass('on').addClass('off');
                                    //$('.caption').css('margin', '0 0 0 86px');
                    })

                    $('#button2').click(function () {
                        if ($('#button2').hasClass('cl'))
                            $('#button2').removeClass('cl').addClass('on'),
                                    $('.diagram').hide(),
                                    $('.them').fadeIn(),
                                    $('#slider').css('width', '600px'),
                                    $('.tick').css('width', '42.8px'),
                                    $('.try1').css('margin-left', '126px'),
                                    $('.try2').css('margin-left', '-36px'),
                                    $('.try3').css('margin-left', '-45px'),
                                    $('.try4').css('margin-left', '-45px'),
                                    $('.captions').css('margin', '8px 0 0 -164px'),
                                    $('.legend1').css('margin', '440px 250px 0 645px'),
                                    $('.legend2').css('margin', '14px 295px 0 645px'),
                                    $('svg').attr('height', height+160),
                                    $('.diagramContainer').css('height', height+160),
                                    $('#button1').removeClass('on').addClass('off');
                                    //$('.caption').css('margin', '100px 0 0 86px');
                    })


                    $(".legend1").html("<p><b>Доля ошибок</b></p> " +
                    "<p><b>в ответах</b></p> ");

                    $(".legend2").html(
                            "<p> <span style='background-color:" + color(40) + ";color:" + color(40) + ";'> /../ </span> <span style='float:right;'> 60% </span> </p>" +
                            "<p> <span style='background-color:" + color(55) + ";color:" + color(55) + ";'> /../ </span> </p>" +
                            "<p> <span style='background-color:" + color(70) + ";color:" + color(70) + ";'> /../ </span> </span> <span style='float:right;'> 30% </span> </p>" +
                            "<p> <span style='background-color:" + color(78) + ";color:" + color(78) + ";'> /../ </span>  </p>" +
                            "<p> <span style='background-color:" + color(85) + ";color:" + color(85) + ";'> /../ </span> </span> <span style='float:right;'> 15% </span> </p>" +
                            "<p> <span style='background-color:" + color(90) + ";color:" + color(90) + ";'> /../ </span>  </p>" +
                            "<p> <span style='background-color:" + color(95) + ";color:" + color(95) + ";'> /../ </span> </span> <span style='float:right;'> 5% </span> </p>"
                    );

                    svg = d3.select(".diagram").append("svg")
                            .attr("width", width)
                            .attr("height", height)
                            .append("g")
                            .attr('class', 'diagG');


                    //.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    minRightAnsw = findMaxError(nested[currentTry].values);

                    //пустые массивы, чтобы создать нужное кол-во заготовок билетов и вопросов
                    fakeQuestions = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20];
                    fakeTickets = [fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions,
                        fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions,
                        fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions,
                        fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions, fakeQuestions];

                    //создаем пустую диаграмму
                    questions = svg
                            .selectAll('g')
                            .attr('y', 40)
                            .data(function (d) {//console.log("FAKE T: ", fakeTickets);
                                return fakeTickets;
                            })
                            .enter()
                            .append('g')
                            .attr('id', function (d, i) {//console.log(d);
                                return i
                            })

                            .attr('class', 'tkt')
                            .attr('transform', function (d, i) {
                                //console.log(i,d);
                                //return 'translate('+ (size *((i*5)%20)+30*(i%5))+',' + (size*((i-i%4)/4)*4 + 30*((i-i%5)/5))+ ')'
                                return 'translate(' + (size * ((i * 5) % 40) + 18 * (i % 8)) + ',' + (size * ((i - i % 8) / 8) * 5.5) + ')'
                            })
                            .selectAll('rect')
                            .data(function (d) {
                                return d;
                            })
                            .enter()
                            .append('rect')
                            .attr('id', function (d, i) {
                                return d
                            })
                            .attr('x', function (d, i) {
                                return (i % 5) * size
                            })
                            .attr('y', function (d, i) {
                                return (i - i % 5) / 5 * size
                            })
                            .attr('width', size)
                            .attr('height', size)
                            .attr('fill', '#eee');


                    tem = d3.select(".them").append("svg")
                            .attr("width", width)
                            .attr("height", height)
                            .append("g")
                            .attr('class', 'themG');

                    //пустые массивы, чтобы создать нужное кол-во заготовок билетов и вопросов
                    fake1 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40];
                    fake2 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
                        41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80,
                        81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116,
                        117, 118, 119, 120];
                    fakeThemes = [fake1, fake2, fake1, fake1, fake2, fake1, fake1, fake1, fake2, fake1, fake1, fake2];


                    themes = tem
                            .selectAll('g')
                            .attr('y', 40)
                            .data(function (d) {//console.log("FAKE T: ", fakeTickets);
                                return fakeThemes;
                            })
                            .enter()
                            .append('g')
                            .attr('id', function (d, i) {//console.log(i);
                                return i
                            })

                            .attr('class', 'tkt')
                            .attr('transform', function (d, i) {
                                if (i < 2) {
                                    return 'translate(' + 0 + ',' + ((size * i * 2.5) + size) + ')';
                                }
                                else {
                                    if (i < 5) {
                                        return 'translate(' + 0 + ',' + (size * i * 2.5 + 2 * size + size) + ')';
                                    }
                                    else {
                                        if (i < 9) {
                                            return 'translate(' + 0 + ',' + (size * i * 2.5 + 4 * size + size) + ')';
                                        }
                                        else {
                                            return 'translate(' + 0 + ',' + (size * i * 2.5 + 6 * size + size) + ')';
                                        }
                                    }
                                }
                            })
                            .selectAll('rect')
                            .data(function (d) {
                                return d;
                            })
                            .enter()
                            .append('rect')
                            .attr('id', function (d, i) {
                                return d
                            })
                            .attr('x', function (d, i) {
                                return (i % 40) * size
                            })
                            .attr('y', function (d, i) {
                                return (i - i % 40) / 40 * size
                            })
                            .attr('width', size)
                            .attr('height', size)
                            .attr('fill', '#eee');


                    //заполняем пустую диаграмму данными
                    updateDiagram(1);
                });
            });
                }



</script>

</body>
</html>
